<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualização do Currículo</title>
  <link rel="icon" href="icon.png" type="image/png" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #eaeaea;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #curriculo-viewer {
      position: relative;
      width: 794px;
      height: 1123px;
      overflow: hidden;
      background: white;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      margin-top: 40px;
    }

    .pagina {
      position: absolute;
      top: 0;
      left: 0;
      width: 794px;
      height: 1123px;
      display: none;
    }

    .pagina.active {
      display: block;
    }

    #navegacao {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: -550px;
    }

    #navegacao button {
      background-color: #00324a;
      color: white;
      padding: 8px 16px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    #navegacao button:hover {
      background-color: #005066;
    }

    .botoes {
      margin-top: -55fna0px;
      text-align: center;
    }

    .botoes button {
      background-color: #00324a;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 10px;
      margin: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .botoes button:hover {
      background-color: #005066;
    }

    #curriculo {
      width: 794px;
      padding: 60px;
      box-sizing: border-box;
      background: white;
    }

    h1 { font-size: 32px; margin-bottom: 10px; color: #00324a; }
    h2 { font-size: 20px; margin-top: 30px; color: #00324a; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    ul { padding-left: 20px; margin-top: 10px; }
    li { margin-bottom: 8px; }
    .info-topo { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .foto { width: 120px; height: 160px; border-radius: 5px; object-fit: cover; border: 1px solid #ccc; }

    @media (max-width: 800px) {
  #curriculo-viewer {
    transform: scale(0.4);
    transform-origin: top center;
  }

  .pagina img {
    width: 100%;
    height: auto;
  }

  #navegacao button {
    font-size: 16px;
    padding: 6px 12px;
  }

  .botoes button {
    font-size: 13px;
    padding: 6px 12px;
  }
}
.info-topo p {
  margin: 0;
  padding: 0;
  font-size: 16px;
  line-height: 1.2;
}
  </style>
</head>
<body style="position: relative; overflow-x: hidden; background: white; font-family: 'Segoe UI', sans-serif;">
  <!-- Contêiner das partículas -->
  <div id="particles-js" style="position: fixed; inset: 0; z-index: -1;"></div>

  <div id="curriculo-viewer"></div>

  <div id="navegacao">
    <button id="voltar" style="display:none;">⬅</button>
    <button id="avancar" style="display:none;">➡</button>
  </div>

  <div class="botoes">
    <button onclick="voltarParaCurriculo()">Voltar</button>
    <button onclick="redirecionarParaLoading()">Gerar PDF</button>
  </div>

  <!-- Biblioteca de partículas -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>

  <!-- Configuração das partículas -->
  <script>
    tsParticles.load("particles-js", {
      fullScreen: { enable: false },
      particles: {
        number: { value: 60 },
        color: { value: "#e09d00" },
        shape: { type: "circle" },
        opacity: { value: 0.3 },
        size: { value: 4 },
        move: {
          enable: true,
          speed: 1.5,
          direction: "none",
          outModes: { default: "bounce" }
        }
      },
      background: {
        color: { value: "transparent" }
      }
    });
  </script>

  <!-- Seu script original -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const dados = JSON.parse(localStorage.getItem("curriculo")) || {};
    const curriculo = document.createElement("div");
    curriculo.id = "curriculo";
curriculo.innerHTML = `
  <div class="info-topo">
    <div>
      <h1>${dados.nome || ""}</h1>
      ${dados.email ? `<p><strong>Email:</strong> ${dados.email}</p>` : ""}
      ${dados.telefone ? `<p><strong>Telefone:</strong> ${dados.telefone}</p>` : ""}
      ${dados.idade ? `<p><strong>Idade:</strong> ${dados.idade} anos</p>` : ""}
      ${(dados.endereco || dados.numero || dados.complemento || dados.bairro || dados.cidade || dados.cep) ? `
        <p><strong>Endereço:</strong> 
          ${dados.endereco || ""}${dados.numero ? `, ${dados.numero}` : ""}
          ${dados.complemento ? ` (${dados.complemento})` : ""}
          ${dados.bairro ? ` - ${dados.bairro}` : ""}
          ${dados.cidade ? `, ${dados.cidade}` : ""}
          ${dados.cep ? ` - CEP: ${dados.cep}` : ""}
        </p>` : ""}
      ${dados.infoAdicional ? `<p>${dados.infoAdicional}</p>` : ""}
    </div>
    ${dados.foto ? `<img src="${dados.foto}" class="foto" />` : ""}
  </div>
  ${dados.objetivo ? `<h2>Objetivo</h2><p>${dados.objetivo}</p>` : ""}
  ${dados.formacao ? `<h2>Formação Acadêmica</h2><p>${dados.formacao}</p>` : ""}
`;

    if (Array.isArray(dados.curso)) {
      let html = "";
      for (let i = 0; i < dados.curso.length; i++) {
        const nome = dados.curso[i]?.trim();
        const inst = dados.instituicao[i]?.trim();
        let carga = dados.carga[i]?.trim();
        if (carga && /^\d+$/.test(carga)) carga += "hs";
        if (nome || inst || carga) {
          html += "<li>";
          if (nome) html += `<strong>${nome}</strong>`;
          if (inst) html += ` — ${inst}`;
          if (carga) html += ` <em>(${carga})</em>`;
          html += "</li>";
        }
      }
      if (html) curriculo.innerHTML += `<h2>Cursos</h2><ul>${html}</ul>`;
    }

    if (Array.isArray(dados.empresa)) {
      let html = "";
      for (let i = 0; i < dados.empresa.length; i++) {
        const empresa = dados.empresa[i]?.trim();
        const cargo = dados.cargo?.[i]?.trim();
        const inicio = dados.periodo_inicio?.[i]?.trim();
        const fim = dados.periodo_fim?.[i]?.trim();
        const atividades = dados.atividades?.[i]?.trim();
        const periodo = inicio && fim ? `${inicio} à ${fim}` : inicio || fim || "";
        if (empresa || cargo || periodo || atividades) {
          html += "<li>";
          if (empresa) html += `<strong>${empresa}</strong>${periodo ? ` — <em>${periodo}</em>` : ""}`;
          else if (periodo) html += `<em>${periodo}</em>`;
          if (cargo) html += `<br>${cargo}`;
          if (atividades) html += `<br><span>${atividades}</span>`;
          html += "</li>";
        }
      }
      if (html) curriculo.innerHTML += `<h2>Experiência Profissional</h2><ul>${html}</ul>`;
    }

        const primeiroEmprego = JSON.parse(localStorage.getItem("primeiroEmprego"));
if (primeiroEmprego) {
  let html = "<li>";
  html += `<strong>${primeiroEmprego.empresa}</strong>`;
  if (primeiroEmprego.inicio || primeiroEmprego.fim) {
    const periodo = primeiroEmprego.inicio && primeiroEmprego.fim
      ? `${primeiroEmprego.inicio} à ${primeiroEmprego.fim}`
      : primeiroEmprego.inicio || primeiroEmprego.fim;
    html += ` — <em>${periodo}</em>`;
  }
  if (primeiroEmprego.cargo) html += `<br>${primeiroEmprego.cargo}`;
  if (primeiroEmprego.atividades) html += `<br><span>${primeiroEmprego.atividades}</span>`;
  html += "</li>";

  curriculo.innerHTML += `<h2>Experiência Profissional</h2><ul>${html}</ul>`;
}

    if (dados.habilidades) {
      curriculo.innerHTML += `<h2>Habilidades</h2><p>${dados.habilidades}</p>`;
    }
    if (dados.hobbies) {
      curriculo.innerHTML += `<h2>Hobbies</h2><p>${dados.hobbies}</p>`;
    }

    const clone = curriculo.cloneNode(true);
    clone.style.position = "absolute";
    clone.style.top = "-9999px";
    clone.style.left = "-9999px";
    clone.style.width = "794px";
    clone.style.padding = "60px";
    clone.style.background = "white";
    clone.style.boxSizing = "border-box";
    document.body.appendChild(clone);

    (async () => {
      const canvas = await html2canvas(clone, { scale: 1 });
      document.body.removeChild(clone);
      const pageHeightPx = 1123;
      const totalPages = Math.ceil(canvas.height / pageHeightPx);

      for (let i = 0; i < totalPages; i++) {
        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = 794;
        pageCanvas.height = 1123;
        const ctx = pageCanvas.getContext("2d");
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
        ctx.drawImage(canvas, 0, -i * pageHeightPx);
        const img = document.createElement("img");
        img.src = pageCanvas.toDataURL("image/png");
        img.style.width = "100%";
        img.style.height = "100%";
        const pagina = document.createElement("div");
        pagina.className = "pagina";
        pagina.appendChild(img);
        document.getElementById("curriculo-viewer").appendChild(pagina);
      }

      atualizarVisualizacao();
    })();

    let paginaAtual = 0;
    function atualizarVisualizacao() {
      const paginas = document.querySelectorAll(".pagina");
      paginas.forEach((pagina, index) => {
        pagina.classList.toggle("active", index === paginaAtual);
      });

      document.getElementById("voltar").style.display = paginaAtual > 0 ? "inline-block" : "none";
      document.getElementById("avancar").style.display = paginaAtual < paginas.length - 1 ? "inline-block" : "none";
    }

    document.getElementById("voltar").addEventListener("click", () => {
      if (paginaAtual > 0) {
        paginaAtual--;
        atualizarVisualizacao();
      }
    });

    document.getElementById("avancar").addEventListener("click", () => {
      const paginas = document.querySelectorAll(".pagina");
      if (paginaAtual < paginas.length - 1) {
        paginaAtual++;
        atualizarVisualizacao();
      }
    });

    function voltarParaCurriculo() {
      window.location.href = "curriculo.html";
    }

    async function redirecionarParaLoading() {
      const telefone = dados.telefone || "";

      try {
        await fetch("SEU_ENDPOINT_AQUI", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ telefone })
        });

        localStorage.setItem("curriculoParaEnviar", "true");
        localStorage.setItem("entradaViaSplash", "true");
        localStorage.setItem("navegandoInternamente", "true");

        window.removeEventListener("unload", enviarLogAbandono);
        document.removeEventListener("visibilitychange", handleVisibilityChange);

        window.location.href = "loading.html";
      } catch (error) {
        console.error("Erro ao enviar telefone:", error);
        alert("Falha ao conectar com o servidor.");
      }
    }

    // 🔍 Rastreio de abandono
    console.log("📍 Rastreamento iniciado");
    console.log("entradaViaSplash =", localStorage.getItem("entradaViaSplash"));
    console.log("navegandoInternamente =", localStorage.getItem("navegandoInternamente"));

    const inicio = Date.now();
    const nome = JSON.parse(localStorage.getItem("curriculo"))?.nome || "visitante";
    let etapaAtual = "Visualizou";
    let logEnviado = false
        let entradaViaSplash = localStorage.getItem("entradaViaSplash") === "true";
    let navegandoInternamente = localStorage.getItem("navegandoInternamente") === "true";

    document.addEventListener("click", (e) => {
      const el = e.target.closest("a");
      if (el && el.href && el.href.includes(window.location.origin)) {
        navegandoInternamente = true;
        console.log("➡️ Navegação interna detectada via clique");
      }
    });

    let rastreioLiberado = false;
    setTimeout(() => { rastreioLiberado = true }, 300);

    window.enviarLogAbandono = function () {
      if (logEnviado || !entradaViaSplash || navegandoInternamente) {
        console.log("⛔ Log bloqueado — entradaViaSplash =", entradaViaSplash, "| navegandoInternamente =", navegandoInternamente);
        return;
      }

      logEnviado = true;
      const tempo = Math.round((Date.now() - inicio) / 1000);
      console.log("🚨 Disparando log de abandono após", tempo, "segundos");

      const payload = JSON.stringify({
        acao: "etapa",
        nome,
        etapa: `Abandonou ${etapaAtual} após ${tempo}s`,
        timestamp: new Date().toISOString()
      });

      try {
        const blob = new Blob([payload], { type: "application/json" });
        const ok = navigator.sendBeacon("https://officeexpress.onrender.com/api/logs", blob);
        if (!ok) throw new Error("sendBeacon falhou");
      } catch (err) {
        console.warn("⚠️ sendBeacon falhou, tentando fetch como fallback");
        fetch("https://officeexpress.onrender.com/api/logs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload,
          keepalive: true
        });
      }
    };

    window.handleVisibilityChange = function () {
      console.log("👀 visibilitychange =", document.visibilityState);
      if (document.visibilityState === "hidden" && rastreioLiberado) {
        enviarLogAbandono();
      }
    };

    window.addEventListener("unload", () => {
      console.log("💥 unload disparado");
      enviarLogAbandono();
    });

    document.addEventListener("visibilitychange", handleVisibilityChange);
  </script>
</body>
</html>