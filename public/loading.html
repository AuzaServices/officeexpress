<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerando seu Currículo...</title>
  <link rel="icon" href="icon.png" type="image/png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Arial', sans-serif;
    }
    .spinner-border {
      width: 4rem;
      height: 4rem;
    }
    h2 {
      margin-top: 20px;
      color: #343a40;
    }
  </style>
</head>
<body>
  <div class="text-center">
    <div class="spinner-border text-primary" role="status"></div>
    <h2>Gerando seu currículo...</h2>
    <p class="text-muted">Aguarde alguns instantes</p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    async function enviarCurriculo() {
      const precisaEnviar = localStorage.getItem("curriculoParaEnviar");
      if (!precisaEnviar) return;

      const { jsPDF } = window.jspdf;
      const dados = JSON.parse(localStorage.getItem("curriculo")) || {};
      const pdf = new jsPDF();
      let y = 20;

      const addTitulo = (texto) => {
        pdf.setFontSize(16);
        pdf.setFont("helvetica", "bold");
        pdf.text(texto, 20, y);
        y += 8;
      };

      const addTexto = (texto) => {
        pdf.setFontSize(12);
        pdf.setFont("helvetica", "normal");
        const linhas = pdf.splitTextToSize(texto, 170);
        pdf.text(linhas, 20, y);
        y += linhas.length * 6;
      };

      // Nome
      addTitulo(`Currículo de ${dados.nome || "Nome não informado"}`);
      y += 6;

      // Contato
      if (dados.email) addTexto(`Email: ${dados.email}`);
      if (dados.telefone) addTexto(`Telefone: ${dados.telefone}`);

      let enderecoCompleto = "";
      if (dados.endereco) enderecoCompleto += dados.endereco;
      if (dados.numero) enderecoCompleto += ", " + dados.numero;
      if (dados.complemento) enderecoCompleto += " (" + dados.complemento + ")";
      if (dados.bairro) enderecoCompleto += " - " + dados.bairro;
      if (dados.cidade) {
        const cidadeFormatada = dados.cidade.charAt(0).toUpperCase() + dados.cidade.slice(1).toLowerCase();
        enderecoCompleto += ", " + cidadeFormatada;
      }
      if (dados.cep) enderecoCompleto += " - CEP: " + dados.cep;
      if (enderecoCompleto) addTexto(`Endereço: ${enderecoCompleto}`);

      y += 6;

      // Objetivo
      if (dados.objetivo) {
        addTitulo("Objetivo");
        addTexto(dados.objetivo);
      }

      // Formação
      if (dados.formacao) {
        addTitulo("Formação Acadêmica");
        addTexto(dados.formacao);
      }

      // Cursos
      if (Array.isArray(dados.curso)) {
        addTitulo("Cursos");
        dados.curso.forEach((nome, i) => {
          const inst = dados.instituicao?.[i] || "";
          let carga = dados.carga?.[i] || "";
          if (carga && /^\d+$/.test(carga)) carga += "hs";
          const linha = `${nome} — ${inst} ${carga ? `(${carga})` : ""}`;
          addTexto(linha);
        });
      }

      // Experiência
      if (Array.isArray(dados.empresa)) {
        addTitulo("Experiência Profissional");
        dados.empresa.forEach((empresa, i) => {
          const cargo = dados.cargo?.[i] || "";
          const inicio = dados.periodo_inicio?.[i] || "";
          const fim = dados.periodo_fim?.[i] || "";
          const periodo = inicio && fim ? `${inicio} à ${fim}` : inicio || fim || "";
          const atividades = dados.atividades?.[i] || "";

          let bloco = "";
          if (empresa) bloco += `${empresa}`;
          if (periodo) bloco += ` — ${periodo}`;
          if (cargo) bloco += `\nCargo: ${cargo}`;
          if (atividades) bloco += `\nAtividades: ${atividades}`;

          addTexto(bloco);
        });
      }

      // Habilidades
      if (dados.habilidades) {
        addTitulo("Habilidades");
        addTexto(dados.habilidades);
      }

      // Hobbies
      if (dados.hobbies) {
        addTitulo("Hobbies");
        addTexto(dados.hobbies);
      }

      // Gerar blob e enviar
      const pdfBlob = pdf.output("blob");
      const formData = new FormData();
      formData.append("arquivo", pdfBlob, `curriculo-${dados.nome || "usuario"}.pdf`);
      formData.append("telefone", dados.telefone || "");

      try {
        await fetch("https://officeexpress.onrender.com/api/upload", {
          method: "POST",
          body: formData
        });
        localStorage.removeItem("curriculoParaEnviar");
        window.location.href = "pagamento.html";
      } catch (err) {
        alert("Erro ao enviar PDF. Tente novamente.");
        console.error(err);
      }
    }

    setTimeout(enviarCurriculo, 2000);
  </script>
</body>
</html>